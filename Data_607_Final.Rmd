---
title: "Data 607 Final Project"
author: "Coco Donovan"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction:

I chose to have the focus of my analysis be police incident reports from the City 
of San Francisco Police Department. My intention was to include analysis of crime 
clearance statistics, and unfortunately that is not possible and I will get into 
that dynamic a little during my presentation. Ultimately, I chose to conduct an 
analysis over the years of crime and reports of crime.

### Limitations: 

There is no readily available data for before 2003, so I cannot make quantitative 
statements from my own analysis of crime trends from before 2003 (I would love to
based on reporting I have seen; however that would not be my own work).

There are two different data sets; one from 2003-2018 and another from 2018-current.
From this change in data sources has come a difference in values for the same 
variables (this makes certain forms of analysis difficult to produce).

### Necessary Packages

```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(tidyverse)
```

### Police Incident Data: 2003 - 2017

```{r}
old_police_files  <- list.files(pattern = '^Police_Data_....\\.csv')

old_police_tables <- lapply(old_police_files, read.csv, header = TRUE)

old_police_data <- do.call(rbind , old_police_tables)
```

### Police Incident Data: 2018 - Current

```{r}
present_police_files  <- list.files(pattern = 'Present_Police_Data_....\\.csv')

present_police_tables <- lapply(present_police_files, read.csv, header = TRUE)

present_police_data <- do.call(rbind , present_police_tables)
```

### SF City Budget

A continuation of this analysis could use this file that comes from DataSF detailing
the cities budget over the years, with a specific focus on funding of the Police.

```{r}
budget <- read.csv('Budget.csv')
```

### SF Yearly Population

```{r}
sf_pop <- read.csv('SF_POP.csv')

sf_pop$Population <- 1000 * sf_pop$Population

sf_pop <- sf_pop %>%
  separate(Year, c('year', 'month', 'date'), '-') %>%
  select(year, Population)

sf_pop$year <- as.integer(sf_pop$year)

sf_pop <- sf_pop %>%
  filter(year >= 2003)
```

### Joining New and Old Incident Counts, Reports, and the ratio of the two:

```{r}
old_police_data <- old_police_data %>%
  separate(Date, c("month", "day","year"), "/")

old_police_data$year <- as.integer(old_police_data$year)

old_counts_and_incidents <- old_police_data %>%
  group_by(year) %>%
  summarize(count_reports = as.double(n()), count_incidents = as.double(length(unique(IncidntNum))))

new_counts_and_incidents <- present_police_data %>%
  rename('year' = 'Incident.Year') %>%
  group_by(year) %>%
  summarize(count_reports = as.double(n()), count_incidents = as.double(length(unique(Incident.Number))))

counts_and_incidents <- rbind(new_counts_and_incidents, old_counts_and_incidents)

counts_and_incidents <- counts_and_incidents %>%
  group_by(year) %>%
  mutate(ratio = count_reports/count_incidents) %>%
  arrange(desc(year))

knitr::kable(counts_and_incidents)
```

### Visualizations: Incidents Over Time

```{r}
# I did not include 2023 just yet, because the year is only a about 1/3 of the 
# way over and would not contribute to reliable comparisions for raw counts

counts_and_incidents_no_2023 <- subset(counts_and_incidents, year != 2023)

ggplot(counts_and_incidents_no_2023, aes(x= year, y= count_incidents)) +
  geom_point() +
  geom_line() +
  labs(x = 'Year', y = 'Incidents per Year', title = 'Incidents per Year Since 2003')
```

### Visualization: Ratio of reports vs acutal incidents

```{r}
ggplot(counts_and_incidents, aes(x= year, y= ratio)) +
  geom_point() +
  geom_line() +
  labs(x = 'Year', y = 'Ratio of Reports Filed v.s. Actual Incidents', title = 'The Ratio of Reported Crimes to Actual Incidents Since 2003')
```

### Adding population to counts and incidents

```{r}
years_and_counts <- full_join(sf_pop, counts_and_incidents, by = 'year')
```

### Crime per 100K

```{r}
years_and_counts <- years_and_counts %>%
  mutate(incidents_per_100k = 100000 * count_incidents/Population) %>%
  arrange(desc(year))

knitr::kable(years_and_counts)
```

### Visualization: Crime Incidents per 100k

```{r}
ggplot(years_and_counts, aes(x= year, y= incidents_per_100k)) +
  geom_point() +
  geom_line() +
  labs(x = 'Year', y = 'Incidents per Year per 100k Residents', title = 'Incidents per Year per 100k Residents Since 2003')
```

### Visualization: Ratio of Reports vs Incidents per 100K over time

```{r}
years_and_count_ratio_100k <-years_and_counts %>%
  mutate(ratio_per_100k = count_reports / incidents_per_100k) %>%
  arrange(desc(year))

ggplot(years_and_count_ratio_100k, aes(x= year, y= ratio_per_100k)) +
  geom_point() +
  geom_line() +
  labs(x = 'Year', y = 'Ratio of Reports Filed v.s. Actual Incidents per 100k residents', title = 'The Ratio of Reported Crimes to Actual Incidents Since 2003 per 100k residents')
```

### Arrest Rate Rate

This is not possible for over time comparison and that has to do with how SF records 
"Resolutions" to incidents. There is no easily accessible (I could not find any after
scouring SFPD's website and SF City and County Documentation) documentation on what 
each resolution type meant for the older data, and then the classifications were 
changed with no explanation. Due to this lack of transparency, it is difficult to 
track crime clearance rates over time. It does seem that this is data that does 
exist internally and it is not open sourced.

```{r}
new_outcomes <- present_police_data %>%
  group_by(Resolution) %>%
  summarize(counts = n())

unique(new_outcomes$Resolution)

old_outcomes <- old_police_data %>%
  group_by(Resolution) %>%
  summarize(count = n())

unique(tolower(old_outcomes$Resolution))
```

### Analysis of Crime Type:

```{r}
incident_codes <- read.csv()

type_old <- old_police_data %>%
  select(year, IncidntNum, Incident.Code) %>%
  rename(Incident.Number = IncidntNum, Incident.Year = year)

type_new <- present_police_data %>%
  select(Incident.Year, Incident.Number, Incident.Code)

total_type <- bind_rows(type_old, type_new)

types <- left_join(total_type, incident_codes)
```

### Conclusion:

The trends that I observed were as follows:

The incidents of crime have gone up yearly, over the timeframe, with the exception 
of the pandemic. However, when we look at crime per 100K residents, crime has 
gone down generally, with a large increase during the pandemic. 

What is especially of note is that as crime per 100k residents, the reporting of
crime increased. It is difficult to comment on exactly why that is because of 
lack of clearance rates and the inconsistency with the "Resolution" variable in 
both police incident report data sets.
